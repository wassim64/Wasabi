<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Music Genre Tree Visualizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    .node circle {
      fill: #fff;
      stroke: steelblue;
      stroke-width: 1.5px;
    }

    .node text {
      font: 10px sans-serif;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
  </style>
</head>
<body>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script>
    function getGenreFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("genre");
    }

    // Fonction pour rechercher un sous-genre dans les genres
    function findParentGenre(data, subgenreName) {
        for (let genre of data) {
            for (let subgenre of genre.subgenres) {
                if (typeof subgenre === 'string' && subgenre.toLowerCase() === subgenreName.toLowerCase()) {
                    return genre; // Retourne le genre parent du sous-genre
                } else if (subgenre.genre.toLowerCase() === subgenreName.toLowerCase()) {
                    return genre; // Retourne le genre parent du sous-genre
                }
            }
        }
        return null; // Si le genre ou sous-genre n'est pas trouvé
    }

    function transformData(data) {
      return {
        name: "Genres",
        children: data.map(genre => ({
          name: genre.genre,
          children: genre.subgenres.map(sub => 
            typeof sub === 'string' 
            ? { name: sub } 
            : { name: sub.genre, children: sub.subgenres.map(s => ({ name: s })) }
          )
        }))
      };
    }

    d3.json('sous-genre.json').then(data => {
        const genreParam = getGenreFromUrl();
        let genreData = data.find(genre => genre.genre.toLowerCase() === genreParam.toLowerCase());

        // Si genre non trouvé, vérifier si c'est un sous-genre
        if (!genreData) {
            genreData = findParentGenre(data, genreParam);
        }

        if (!genreData) {
            console.error(`Genre ou sous-genre "${genreParam}" non trouvé.`);
            return;
        }

        let root;
        if (genreData.subgenres.some(sub => typeof sub === 'string' && sub.toLowerCase() === genreParam.toLowerCase())) {
            // Si c'est un sous-genre, on ne prend que ce sous-genre et son genre parent
            root = {
                name: genreData.genre,
                children: genreData.subgenres
                  .filter(sub => typeof sub === 'string' && sub.toLowerCase() === genreParam.toLowerCase())
                  .map(sub => {
                    return {
                      name: sub,
                      children: genreData.subgenres
                        .filter(s => s !== sub && typeof s !== 'string') // ne pas afficher les autres sous-genres de ce genre parent
                        .map(s => ({ name: s.genre }))
                    };
                  })
            };
        } else {
            // Si c'est un genre principal, on utilise les données complètes
            root = transformData([genreData]);
        }

        console.log("Données transformées :", root);

        // Suite du code pour créer et afficher l'arbre
        const width = window.innerWidth;
        const height = window.innerHeight * 1.5;
        const tree = d3.tree()
            .size([height, width / 1.5])
            .separation((a, b) => {
                return a.parent === b.parent ? 10 : 10;
            });

        const hierarchy = d3.hierarchy(root);
        const root_node = tree(hierarchy);

        const svg = d3.select('body')
          .append('svg')
          .attr('width', width)
          .attr('height', height)
          .style("transform", "scale(0.8)");

        const link = svg.selectAll('.link')
          .data(root_node.links())
          .enter().append('path')
          .attr('class', 'link')
          .attr('d', d3.linkHorizontal()
            .x(d => d.y)
            .y(d => d.x));

        const node = svg.selectAll('.node')
          .data(root_node.descendants())
          .enter().append('g')
          .attr('class', 'node')
          .attr('transform', d => `translate(${d.y}, ${d.x})`);

        node.append('circle')
          .attr('r', 4.5);

        node.append('text')
          .attr('dx', 10)
          .attr('dy', 15)
          .style('text-anchor', 'start')
          .style('font-size', '50px')
          .text(d => d.data.name);
    });
  </script>
</body>
</html>
